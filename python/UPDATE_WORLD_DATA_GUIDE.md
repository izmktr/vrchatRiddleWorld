# ワールドデータ更新プログラム

`update_world_data.py`は、VRChatワールドデータの自動更新を行うプログラムです。既存データの効率的な更新と、新規ワールドの自動追加を行います。

## 機能概要

### 1. 既存ワールドの更新処理
- **intelligent更新判定**: 長期間更新されていないワールドは更新間隔を延ばす
- **キャッシュ機能**: 24時間以内の重複更新を防止
- **レート制限**: VRChat APIに配慮し、2秒間隔でリクエスト実行

### 2. 新規ワールドの処理
- `new_worlds`コレクションから未処理ワールドを自動取得
- ワールドデータ取得後に`worlds`コレクションに追加
- 処理済みデータの自動削除

### 3. データ保存
- MongoDBへのupsert操作（既存データの更新・新規データの挿入）
- 生データ（JSON）の`raw_data`フォルダへの保存
- エラー発生時の詳細ログ出力

## 更新判定ロジック

### 条件
ワールドが更新対象となるのは以下の条件のいずれかを満たす場合：

1. **条件1（活動度ベース）**: 
   - `経過時間 × 10 > 最終アップデート時間`
   - 長期間更新されていないワールドは更新頻度を下げる

2. **条件2（最大期間）**: 
   - `経過時間 ≥ 30日`
   - どんなに古いワールドでも30日以上は待たない

### 最小更新間隔
- 24時間以内の再更新は実行しない
- VRChatWorldScraperのキャッシュ機能と連携

## 使用方法

### 1. 手動実行
```bash
python python/update_world_data.py
```

### 2. VS Code Taskから実行
```bash
# VS Code内で Ctrl+Shift+P → "Tasks: Run Task" → "Update World Data"
```

### 3. 定期実行（推奨）
スケジューラーやcronジョブで定期実行：
```bash
# 例: 1日1回実行
0 2 * * * cd /path/to/project && python python/update_world_data.py
```

## 出力例

```
🔄 ワールドデータ更新プログラム
==================================================
🔄 既存ワールドの更新処理を開始...
📋 425件のワールドデータを取得しました
🎯 35件が更新対象です

🔄 [1/35] 更新中: wrld_ff4238e0-880d-4712-b939-71107518dd02
✅ 更新完了: wrld_ff4238e0-880d-4712-b939-71107518dd02

➕ 新規ワールドの処理を開始...
📋 14件の新規ワールドを処理します

🔄 [1/14] 新規ワールド処理: https://vrchat.com/home/world/wrld_6663bf66...
✅ 新規ワールド追加完了: wrld_6663bf66-58e9-4fb2-8bb6-909ee41e91bd

==================================================
📊 ワールドデータ更新結果サマリー
✅ 成功: 49件
⏭️  スキップ: 0件
❌ エラー: 0件
==================================================
🎉 エラーなく全て処理が完了しました！
```

## エラー処理

### エラーログ
- エラー発生時は`error_world.txt`にログを出力
- ワールドID、エラー内容、発生時刻を記録

### ステータス管理
- `new_worlds`コレクション内のワールドステータス：
  - `pending`: 未処理
  - `processing`: 処理中
  - `completed`: 完了（自動削除対象）
  - `error`: エラー発生

## 依存関係

### Python ライブラリ
- `pymongo`: MongoDB操作
- `requests`: HTTP通信
- `beautifulsoup4`: HTML解析
- `python-dotenv`: 環境変数管理

### 内部ライブラリ
- `lib.mongodb_manager`: MongoDB接続管理
- `lib.vrchat_scraper`: VRChat API操作
- `lib.utils`: ユーティリティ関数

### 環境変数
```env
MONGODB_URI=mongodb+srv://...
MONGODB_DB_NAME=vrcworld
MONGODB_COLLECTION_NAME=worlds
VRCHAT_USERNAME=your_username
VRCHAT_PASSWORD=your_password
```

## パフォーマンス特性

- **メモリ使用量**: 全ワールドデータを一度に読み込むため、データ量に比例
- **実行時間**: 更新対象数 × 2秒 + API応答時間
- **API制限**: 2秒間隔のレート制限でVRChat APIを保護

## 注意事項

1. **VRChat利用規約の遵守**: 過度なAPI使用は避けてください
2. **認証情報の管理**: 環境変数で安全に管理してください
3. **ネットワーク環境**: 安定したネットワーク接続が必要です
4. **データ整合性**: 実行中の中断は避けてください

## トラブルシューティング

### よくある問題

1. **認証エラー**
   - VRChat認証情報を確認
   - `vrchat_session.json`の有効性をチェック

2. **MongoDB接続エラー**
   - `MONGODB_URI`環境変数を確認
   - ネットワーク接続を確認

3. **メモリ不足**
   - 大量データの場合は分割実行を検討
   - 不要な生データファイルを削除

### ログ確認
```bash
# 直近のエラーログ確認
tail -n 50 error_world.txt

# 実行ログの確認
# プログラム実行時にコンソールに出力される情報を確認
```
